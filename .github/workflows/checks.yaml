name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:

  # ── JVM ────────────────────────────────────────────────────────────────────
  jvm:
    name: JVM Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle & build outputs
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Run JVM tests
        run: ./gradlew :jvmTest --no-daemon --continue

      - name: Upload JVM test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jvm-test-results
          path: build/test-results/jvmTest/*.xml

  # ── Linux native ───────────────────────────────────────────────────────────
  linux-native:
    name: Linux Native Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle & Kotlin/Native toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.konan
          key: gradle-native-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: gradle-native-${{ runner.os }}-

      - name: Run Linux native tests
        run: ./gradlew :linuxX64Test --no-daemon --continue

      - name: Upload Linux native test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-native-test-results
          path: build/test-results/linuxX64Test/*.xml

  # ── iOS Simulator ──────────────────────────────────────────────────────────
  ios-simulator:
    name: iOS Simulator Tests
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle & Kotlin/Native toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.konan
          key: gradle-native-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: gradle-native-${{ runner.os }}-

      - name: Run iOS Simulator tests
        run: ./gradlew :iosSimulatorArm64Test --no-daemon --continue

      - name: Upload iOS Simulator test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-test-results
          path: build/test-results/iosSimulatorArm64Test/*.xml
